@{
    ViewData["Title"] = "Citas asignadas";
}

@section Estilos {
  
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css">
    
    <style>
      
        .acciones-container {
            display: flex;
            gap: 4px;
        }

        .btn-circle {
            width: 32px;
            height: 32px;
            padding: 0;
            border-radius: 50%;
            text-align: center;
            font-size: 14px;
            line-height: 32px;
            display: inline-block;
            vertical-align: middle;
        }

        #tbData {
            border-collapse: collapse !important;
        }

        @@media (max-width: 768px) {
            #tbData thead th:first-child, 
            #tbData tbody td:first-child {
                position: sticky;
                left: 0;
                background-color: #f8f9fa !important;
                z-index: 5;
                border-right: 2px solid #dee2e6;
            }
        }
       

        .dataTables_processing {
            background-color: #ffcccc !important;
            color: #d9534f !important;
            font-weight: bold !important;
            font-size: 1.2rem !important;
            border: 2px solid #d9534f !important;
            z-index: 9999 !important;
            top: 50% !important;
            height: auto !important;
            padding: 20px !important;
        }

        .tooltip-light {
            --bs-tooltip-bg: #fff;
            --bs-tooltip-color: #000;
            --bs-tooltip-opacity: 1;
        }

        .tooltip-light .tooltip-inner {
            border: 1px solid rgba(0,0,0,.15);
        }
    </style>
}

<div class="container-fluid px-2 px-md-4">

    <h2 class="mt-4 mb-4 d-flex align-items-center">
        <span>Citas asignadas</span>

        <button type="button"
                class="btn btn-sm ms-auto"
                style="background-color:#ff8c00;color:#fff;border-color:#ff8c00;"
                onclick="openHelpVideo('Doctor_Horario.mp4')"
                data-bs-toggle="tooltip" data-bs-placement="top" data-bs-custom-class="tooltip-citas"
                title="Ayuda">
            <i class="fa fa-circle-question me-1"></i> Ayuda
        </button>
    </h2>

    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <div class="row g-2 align-items-center">
                <div class="col-12 col-md-4">
                    <label class="form-label" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-custom-class="tooltip-light" title="Filtrar por estado">Filtrar por estado</label>
                    <select class="form-select" id="cboEstadoCita">
                        <option value="1" selected>Pendiente</option>
                        <option value="2">Atendido</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table id="tbData" class="table table-striped table-bordered table-hover w-100 align-middle" style="width:100%">
                    <thead>
                        <tr>
                           
                            <th>Acciones</th>
                           
                            <th>Fecha Cita</th>
                            <th>Hora Cita</th>
                            <th>Paciente</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="mdData" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="mdDataLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mdDataLabel">Resumen de la cita</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body">
                <div class="row g-2 mb-2">
                    <div class="col-12">
                        <label class="form-label">Paciente</label>
                        <input type="text" class="form-control" id="txtPaciente" autocomplete="off" disabled>
                    </div>
                </div>

                <div class="row g-2 mb-2">
                    <div class="col-12 col-md-6">
                        <label class="form-label">Fecha cita</label>
                        <input type="text" class="form-control" id="txtFechaCitaResumen" autocomplete="off" disabled />
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Hora cita</label>
                        <input type="text" class="form-control" id="txtHoraCitaResumen" autocomplete="off" disabled />
                    </div>
                </div>

                <div class="row g-2 mb-2">
                    <div class="col-12 col-md-6">
                        <label class="form-label">Origen de la cita</label>
                        <input type="text" class="form-control" id="txtOrigenCita" autocomplete="off" disabled />
                    </div>
                </div>

                <hr />

                <div class="row g-2 mb-2">
                    <div class="col-12">
                        <label class="form-label">Motivo indicado por el paciente</label>
                        <textarea class="form-control" id="txtRazonCitaUsr" rows="3" readonly></textarea>
                    </div>
                </div>

                <div class="row g-2 mb-3">
                    <div class="col-12">
                        <label class="form-label d-block">Documento aportado por el paciente</label>
                        <button type="button" id="btnVerDocPaciente" class="btn btn-outline-secondary btn-sm" disabled>Ver documento del paciente</button>
                        <div class="mt-1">
                            <small id="lblDocPacienteSin" class="text-muted d-none">El paciente no adjuntó ningún documento.</small>
                            <small id="lblDocPacienteCon" class="text-success d-none">✔ Documento del paciente disponible.</small>
                        </div>
                    </div>
                </div>

                <hr />

                <div class="alert alert-primary" role="alert">
                    Escriba las indicaciones para el paciente y, si lo desea, adjunte un informe o documento del doctor.
                </div>

                <div class="row g-2 mb-3">
                    <div class="col-12">
                        <label class="form-label">Indicaciones del doctor</label>
                        <textarea class="form-control" id="txtIndicaciones" rows="3"></textarea>
                    </div>
                </div>

                <div class="row g-2 mb-2">
                    <div class="col-12">
                        <label class="form-label d-block">Documento del doctor</label>
                        <button type="button" id="btnVerDocDoctor" class="btn btn-outline-secondary btn-sm" disabled>Ver documento del doctor</button>
                        <div class="mt-1">
                            <small id="lblDocDoctorSin" class="text-muted d-none">No hay documento registrado del doctor para esta cita.</small>
                            <small id="lblDocDoctorCon" class="text-success d-none">✔ Documento del doctor disponible.</small>
                        </div>
                    </div>
                </div>

                <div class="row g-2 mb-2">
                    <div class="col-12">
                        <label class="form-label">Adjuntar / actualizar documento del doctor</label>
                        <input type="file" class="form-control" id="fileDocDoctor" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">
                    </div>
                </div>

            </div>

            <div class="modal-footer d-flex flex-wrap gap-2">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="btnTerminarCita">Guardar / marcar como atendida</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        (function () {
          "use strict";
          window.openHelpVideo = function (fileName) {
            const w = 900, h = 520;
            const left = Math.max(0, (screen.width - w) / 2);
            const top = Math.max(0, (screen.height - h) / 2);
            const url = "/helps/" + encodeURIComponent(fileName);
            window.open(url, "helpVideo", `width=${w},height=${h},left=${left},top=${top},resizable=yes`);
          };
        })();

        function initTooltips(scope) {
            const root = scope || document;
            const triggers = root.querySelectorAll('[data-bs-toggle="tooltip"]');
            triggers.forEach(el => {
                const inst = bootstrap.Tooltip.getInstance(el);
                if (!inst) new bootstrap.Tooltip(el);
            });
        }

        (function () {
            let tablaData;
            let idCitaSeleccionada = 0;
            const controlador = "Doctor";
            const modal = "mdData";

            let docPacienteBase64 = null;
            let docPacienteContentType = null;
            let docDoctorBase64 = null;
            let docDoctorContentType = null;

            $(document).ready(function () {
                initTooltips();
                tablaData = $('#tbData').DataTable({
                    processing: true,
                    serverSide: true,
                    scrollX: true,
                    ajax: {
                        url: '/' + controlador + '/ListaCitasAsignadasServerSide',
                        type: 'POST',
                        dataType: 'json',
                        data: function (d) {
                            d.idEstadoCita = parseInt($('#cboEstadoCita').val() || '1');
                            return d;
                        }
                    },
                    columns: [
                      
                        {
                            data: "idCita",
                            width: "80px",
                            orderable: false,
                            render: function () {
                                return `<div class="acciones-container">
                                            <button type="button" class="btn btn-warning btn-circle text-white btn-indicaciones" title="Indicaciones">
                                                <i class="fas fa-notes-medical"></i>
                                            </button>
                                        </div>`;
                            }
                        },
                       
                        { data: "fechaCita", width: "150px" },
                        { data: "horaCita", width: "150px" },
                        {
                            data: "usuario",
                            render: function (data) { return (data?.nombre || "") + " " + (data?.apellido || ""); }
                        },
                        {
                            data: "estadoCita",
                            render: function (data) {
                                if (!data || !data.nombre) return "";
                                return data.nombre === "Pendiente"
                                    ? `<span class="badge bg-primary">${data.nombre}</span>`
                                    : `<span class="badge bg-success">${data.nombre}</span>`;
                            }
                        }
                    ],
                    order: [[1, "desc"], [2, "asc"]],
                    language: { url: "https://cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json" },
                    drawCallback: function () { initTooltips(document.getElementById("tbData")); }
                });

                $("#cboEstadoCita").on("change", () => tablaData.ajax.reload());

                $("#tbData tbody").on("click", ".btn-indicaciones", function () {
                    const data = tablaData.row($(this).closest('tr')).data();
                    idCitaSeleccionada = data.idCita;
                    $("#txtPaciente").val(((data.usuario?.nombre) || "") + " " + ((data.usuario?.apellido) || ""));
                    $("#txtFechaCitaResumen").val(data.fechaCita || "");
                    $("#txtHoraCitaResumen").val(data.horaCita || "");
                    $("#txtOrigenCita").val(data.origenCita || "");
                    $("#txtRazonCitaUsr").val(data.razonCitaUsr || "");
                    $("#txtIndicaciones").val(data.indicaciones || "");

                    docPacienteBase64 = data.documentoCitaUsr;
                    docPacienteContentType = data.contentType || "application/octet-stream";
                    if (docPacienteBase64) {
                        $("#btnVerDocPaciente").prop("disabled", false).addClass("btn-outline-success").removeClass("btn-outline-secondary");
                        $("#lblDocPacienteSin").addClass("d-none"); $("#lblDocPacienteCon").removeClass("d-none");
                    } else {
                        $("#btnVerDocPaciente").prop("disabled", true).removeClass("btn-outline-success").addClass("btn-outline-secondary");
                        $("#lblDocPacienteSin").removeClass("d-none"); $("#lblDocPacienteCon").addClass("d-none");
                    }

                    docDoctorBase64 = data.docIndicacionesDoctor;
                    docDoctorContentType = data.contentTypeDoctor || "application/octet-stream";
                    if (docDoctorBase64) {
                        $("#btnVerDocDoctor").prop("disabled", false).addClass("btn-outline-success").removeClass("btn-outline-secondary");
                        $("#lblDocDoctorSin").addClass("d-none"); $("#lblDocDoctorCon").removeClass("d-none");
                    } else {
                        $("#btnVerDocDoctor").prop("disabled", true).removeClass("btn-outline-success").addClass("btn-outline-secondary");
                        $("#lblDocDoctorSin").removeClass("d-none"); $("#lblDocDoctorCon").addClass("d-none");
                    }

                    $("#fileDocDoctor").val("");
                    const esAtendido = data.estadoCita?.nombre === "Atendido";
                    $(".alert-primary").text(esAtendido ? "La cita ya está ATENDIDA, pero puede actualizar las indicaciones y el documento." : "Escriba las indicaciones para el paciente y adjunte un documento si lo desea.");
                    $("#" + modal).modal("show");
                });

                $("#btnVerDocPaciente").on("click", function () {
                    if (!docPacienteBase64) return;
                    const byteChars = atob(docPacienteBase64);
                    const byteNums = new Array(byteChars.length);
                    for (let i = 0; i < byteChars.length; i++) byteNums[i] = byteChars.charCodeAt(i);
                    const blob = new Blob([new Uint8Array(byteNums)], { type: docPacienteContentType || "application/octet-stream" });
                    window.open(URL.createObjectURL(blob), "_blank");
                });

                $("#btnVerDocDoctor").on("click", function () {
                    if (!docDoctorBase64) return;
                    const byteChars = atob(docDoctorBase64);
                    const byteNums = new Array(byteChars.length);
                    for (let i = 0; i < byteChars.length; i++) byteNums[i] = byteChars.charCodeAt(i);
                    const blob = new Blob([new Uint8Array(byteNums)], { type: docDoctorContentType || "application/octet-stream" });
                    window.open(URL.createObjectURL(blob), "_blank");
                });

                $("#btnTerminarCita").on("click", function () {
                    if ($("#txtIndicaciones").val().trim() === "") return Swal.fire("Importante", "Debe ingresar las indicaciones.", "warning");
                    const objeto = { IdCita: idCitaSeleccionada, EstadoCita: { IdEstadoCita: 2 }, Indicaciones: $("#txtIndicaciones").val().trim() };
                    
                    fetch("/" + controlador + "/CambiarEstado", {
                        method: "POST", headers: { "Content-Type": "application/json;charset=utf-8" },
                        body: JSON.stringify(objeto)
                    }).then(r => r.json()).then(rj => {
                        if (rj.data === "") {
                            const file = document.getElementById("fileDocDoctor").files[0];
                            if (file) {
                                const reader = new FileReader();
                                reader.onload = function (e) {
                                    const objDoc = { IdCita: idCitaSeleccionada, DocIndicacionesDoctor: e.target.result.split(",")[1], ContentTypeDoctor: file.type };
                                    fetch("/" + controlador + "/GuardarDocumentoDoctor", {
                                        method: "POST", headers: { "Content-Type": "application/json;charset=utf-8" },
                                        body: JSON.stringify(objDoc)
                                    }).then(res => res.json()).then(() => {
                                        Swal.fire("Listo!", "Cita marcada como atendida y documento guardado.", "success");
                                        $("#" + modal).modal("hide"); tablaData.ajax.reload();
                                    });
                                };
                                reader.readAsDataURL(file);
                            } else {
                                Swal.fire("Listo!", "La cita fue marcada como ATENDIDO.", "success");
                                $("#" + modal).modal("hide"); tablaData.ajax.reload();
                            }
                        } else { Swal.fire("Error!", rj.data, "warning"); }
                    });
                });
            });
        })();
    </script>
}
