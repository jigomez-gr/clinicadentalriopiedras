@{
    string urlDestino = "/Citas/Index"; // Valor por defecto (ej. Paciente)

    if (User.IsInRole("Administrador"))
    {
        urlDestino = "/Gestion/Index";
    }
    else if (User.IsInRole("Doctor"))
    {
        urlDestino = "/Citas/CitasAsignadas";
    }
}
@*
    Vista Nueva Cita
    - Paciente: crea su propia cita
    - Administrador: crea cita para el paciente indicado en ViewBag.IdUsuarioPaciente
*@
@section Estilos {
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <style>
        .ui-datepicker-highlight-disabled a {
            border: 1px solid #c5c5c5 !important;
            background: #fff !important;
            font-weight: normal !important;
            color: #454545 !important;
        }
    </style>
}

<h2 class="mt-4 mb-4 d-flex align-items-center">
    <span>Nueva Cita</span>

    <button type="button"
            class="btn btn-sm ms-auto"
            style="background-color:#ff8c00;color:#fff;border-color:#ff8c00;"
            onclick="openHelpVideo('Doctor_Horario.mp4')"
            data-bs-toggle="tooltip" data-bs-placement="top" data-bs-custom-class="tooltip-citas"
            title="Ayuda: abre el vídeo de explicación (wwwroot/helps/Doctor_Horario.mp4).">
        <i class="fa fa-circle-question me-1"></i> Ayuda
    </button>
</h2>

@* Hidden para que el JS sepa el contexto *@

<input type="hidden" id="hdnEsAdmin" value="@(User.IsInRole("Administrador") || User.IsInRole("Doctor") ? "1" : "0")" />
<input type="hidden" id="hdnIdUsuarioPaciente" value="@ViewBag.IdUsuarioPaciente" />
<input type="hidden" id="hdnUrlInicio" value="@urlDestino" />

<div class="card">
    <div id="tabs">
        <ul class="tabs-opcion">
            <li><a href="#tab-especialidad">Especialidad</a></li>
            <li><a href="#tab-doctor">Doctor</a></li>
            <li><a href="#tab-horario">Horario</a></li>
        </ul>

        <div id="tab-especialidad">
            <div class="row mb-4">
                <div class="col-sm-12">
                    <h6 class="mb-3 fw-bold">Buscar Especialidad:</h6>
                    <input type="text" class="form-control" id="txtBuscarEspecialidad" autocomplete="off" />
                </div>
            </div>
            <div id="contenedor-especialidades" class="row row-cols-1 row-cols-md-3">
            </div>
        </div>

        <div id="tab-doctor">
            <div class="row mb-4">
                <div class="col-sm-12">
                    <h6 class="mb-3 fw-bold">Buscar Doctor:</h6>
                    <input type="text" class="form-control" id="txtBuscarDoctor" autocomplete="off" />
                </div>
            </div>
            <div id="contenedor-doctores" class="row row-cols-1 row-cols-md-3">
            </div>
        </div>

        <div id="tab-horario">
            <div class="row mb-4">
                <div class="col-sm-12">
                    <h6 class="mb-3 fw-bold">Fecha Cita</h6>
                    <input type="text" class="form-control" id="txtFechaCita" autocomplete="off" />
                </div>
            </div>

            <div class="row">
                <div class="col-sm-6 mb-3">
                    <h6 class="mb-3 fw-bold">Turno Mañana</h6>
                    <div id="contenedor-am" class="row row-cols-3 row-cols-md-4">
                    </div>
                </div>
                <div class="col-sm-6 mb-3">
                    <h6 class="mb-3 fw-bold">Turno Tarde</h6>
                    <div id="contenedor-pm" class="row row-cols-3 row-cols-md-4">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card-footer">
        <button type="button" class="btn btn-secondary float-start me-2" id="btnRegresar">Regresar</button>
        <button type="button" class="btn btn-primary float-end" id="btnSiguiente">Siguiente</button>
    </div>
</div>

@* Modal de resumen: aquí volvemos a incluir motivo + documento del paciente *@
<div class="modal fade" id="mdData"
     data-bs-backdrop="static"
     data-bs-keyboard="false"
     tabindex="-1"
     aria-labelledby="staticBackdropLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabel">Resumen Cita</h5>
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>

            <div class="modal-body">

                <div class="row mb-2">
                    <div class="col-sm-12">
                        <label class="col-form-label">Especialidad:</label>
                        <input type="text"
                               class="form-control"
                               id="txtEspecialidad"
                               autocomplete="off"
                               disabled />
                    </div>
                </div>

                <div class="row mb-2">
                    <div class="col-sm-12">
                        <label class="col-form-label">Doctor/a:</label>
                        <input type="text"
                               class="form-control"
                               id="txtDoctor"
                               autocomplete="off"
                               disabled />
                    </div>
                </div>

                <div class="row mb-2">
                    <div class="col-sm-12">
                        <label class="col-form-label">Fecha Cita:</label>
                        <input type="text"
                               class="form-control"
                               id="txtFechadeCita"
                               autocomplete="off"
                               disabled />
                    </div>
                </div>

                <div class="row mb-2">
                    <div class="col-sm-12">
                        <label class="col-form-label">Hora Cita:</label>
                        <input type="text"
                               class="form-control"
                               id="txtHoraCita"
                               autocomplete="off"
                               disabled />
                    </div>
                </div>

                <hr />

                <div class="row mb-2">
                    <div class="col-sm-12">
                        <label class="col-form-label">
                            Motivo de la cita (opcional)
                            <small class="text-muted d-block">
                                Este texto lo verá el doctor cuando revise la cita.
                            </small>
                        </label>
                        <textarea class="form-control"
                                  id="txtRazonCitaUsr"
                                  rows="3"></textarea>
                    </div>
                </div>

                <div class="row mb-2">
                    <div class="col-sm-12">
                        <label class="col-form-label">
                            Documento del paciente (opcional)
                            <small class="text-muted d-block">
                                Puede adjuntar un PDF, imagen o documento con informes, radiografías, etc.
                            </small>
                        </label>
                        <input type="file"
                               class="form-control"
                               id="fileDocumentoCitaUsr"
                               accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" />
                    </div>
                </div>

            </div>

            <div class="modal-footer">
                <button type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal">
                    Volver
                </button>
                <button type="button"
                        class="btn btn-primary"
                        id="btnAgendar">
                    Agendar
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/i18n/datepicker-es.min.js"></script>

    <script>
             
                  (function () {
          "use strict";

          // ========= HELP VIDEO (simple) =========
          window.openHelpVideo = function (fileName) {
            const w = 900, h = 520;
            const left = Math.max(0, (screen.width - w) / 2);
            const top = Math.max(0, (screen.height - h) / 2);

            const url = "/helps/" + encodeURIComponent(fileName);

            window.open(
              url,
              "helpVideo",
              `width=${w},height=${h},left=${left},top=${top},resizable=yes,scrollbars=no,toolbar=no,menubar=no,location=no,status=no`
            );
          };
        })();
        let Especialidades = [];
        let Doctores = [];
        let DoctorHorario = [];
        const modal = "mdData";

        let IdEspecialidadSeleccionada = 0;
        let IdDoctorSeleccionado = 0;
        let IdHoraSeleccionado = 0;

        let EspecialidadSeleccionada = "";
        let DoctorSeleccionado = "";
        let HoraSeleccionado = "";

        const IndexTabs = [0, 1, 2];

        // Flags para saber si es admin y el paciente al que se le crea la cita
        let ES_ADMIN = false;
        let ID_USUARIO_PACIENTE = 0;

        document.addEventListener("DOMContentLoaded", function () {

            ES_ADMIN = $("#hdnEsAdmin").val() === "1";
            ID_USUARIO_PACIENTE = parseInt($("#hdnIdUsuarioPaciente").val() || "0");



            // Fallback: si el controller no mandó ViewBag.IdUsuarioPaciente pero viene en querystring (NuevaCita?idUsuario=65)
            if (ES_ADMIN && (!ID_USUARIO_PACIENTE || ID_USUARIO_PACIENTE <= 0)) {
                try {
                    const params = new URLSearchParams(window.location.search);
                    const qs = params.get("idUsuario") || params.get("IdUsuario") || params.get("idUsuarioPaciente") || params.get("IdUsuarioPaciente");
                    if (qs) {
                        const parsed = parseInt(qs);
                        if (!isNaN(parsed) && parsed > 0) {
                            ID_USUARIO_PACIENTE = parsed;
                            $("#hdnIdUsuarioPaciente").val(ID_USUARIO_PACIENTE);
                        }
                    }
                } catch (e) {
                    console.log("No se pudo leer el idUsuario de la URL", e);
                }
            }

            console.log("NuevaCita.js inline cargado. ES_ADMIN =", ES_ADMIN, "ID_USUARIO_PACIENTE =", ID_USUARIO_PACIENTE);

            $.datepicker.setDefaults($.datepicker.regional['es']);
            $("#tabs").tabs();
            $("#txtBuscarEspecialidad").trigger("focus");

            $("#tab-especialidad").LoadingOverlay("show");
            fetch(`/Especialidad/Lista`, {
                method: "GET",
                headers: { 'Content-Type': 'application/json;charset=utf-8' }
            }).then(response => {
                return response.ok ? response.json() : Promise.reject(response);
            }).then(responseJson => {
                $("#tab-especialidad").LoadingOverlay("hide");
                if (responseJson.data.length > 0) {
                    Especialidades = responseJson.data;
                    BuscarEspecialidad("");
                }
            }).catch((error) => {
                $("#tab-especialidad").LoadingOverlay("hide");
                console.log(error);
                Swal.fire({
                    title: "Error!",
                    text: "No se encontraron coincidencias.",
                    icon: "warning"
                });
            });

            $("#tabs").tabs("option", "disabled", [1, 2]);
            $("#btnSiguiente").prop("disabled", true);
        });

        $("#txtBuscarEspecialidad").on("input", function () {
            IdEspecialidadSeleccionada = 0;
            BuscarEspecialidad($(this).val());
            $("#btnSiguiente").prop("disabled", true);
        });

        $("#txtBuscarDoctor").on("input", function () {
            IdDoctorSeleccionado = 0;
            BuscarDoctor($(this).val());
            $("#btnSiguiente").prop("disabled", true);
        });

        $(document).on("click", "div.card-especialidad", function () {
            $(".card-especialidad").removeClass("text-white bg-primary");
            $(this).addClass("text-white bg-primary");

            IdEspecialidadSeleccionada = $(this).data("id");
            EspecialidadSeleccionada = $(this).data("text");
            $("#btnSiguiente").prop("disabled", false);
        });

        $(document).on("click", "div.card-doctor", function () {
            $(".card-doctor").removeClass("text-white bg-primary");
            $(this).addClass("text-white bg-primary");

            IdDoctorSeleccionado = $(this).data("id");
            DoctorSeleccionado = $(this).data("text");
            $("#btnSiguiente").prop("disabled", false);
        });

        $(document).on("click", "div.card-hora", function () {
            $(".card-hora").removeClass("text-white bg-primary");
            $(this).addClass("text-white bg-primary");

            IdHoraSeleccionado = $(this).data("id");
            HoraSeleccionado = $(this).data("text");

            if ($("#txtFechaCita").val() !== "" && IdHoraSeleccionado !== 0)
                $("#btnSiguiente").prop("disabled", false);
        });

        function BuscarEspecialidad(valor) {
            $("#contenedor-especialidades").html("");
            const resultadosFiltrados = Especialidades.filter(
                element => element.nombre.toLowerCase().includes(valor.toLowerCase())
            );
            const resumenFiltro = resultadosFiltrados.slice(0, 4);
            resumenFiltro.forEach(function (item) {
                $("#contenedor-especialidades").append(
                    `<div class="col mb-4">
                        <div class="card h-100 card-especialidad"
                             style="cursor: pointer"
                             data-id="${item.idEspecialidad}"
                             data-text="${item.nombre}">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fa-solid fa-clipboard"></i> ${item.nombre}</h5>
                            </div>
                        </div>
                    </div>`
                );
            });
        }

        function BuscarDoctor(valor) {
            $("#contenedor-doctores").html("");
            const resultadosFiltrados = Doctores.filter(
                element => (element.nombres + element.apellidos).toLowerCase().includes(valor.toLowerCase())
            );
            resultadosFiltrados.forEach(function (item) {
                const acronimo = item.genero === "F" ? "Dra." : "Dr.";
                $("#contenedor-doctores").append(
                    `<div class="col mb-4">
                        <div class="card h-100 card-doctor"
                             style="cursor: pointer"
                             data-id="${item.idDoctor}"
                             data-text="${acronimo} ${item.nombres} ${item.apellidos}">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fa-solid fa-user-doctor"></i> ${acronimo} ${item.nombres} ${item.apellidos}
                                </h5>
                            </div>
                        </div>
                    </div>`
                );
            });
        }

        $("#btnSiguiente").on("click", function () {
            const indexTab = $("#tabs").tabs("option", "active");

            let habilitarIndex = indexTab;
            if (indexTab + 1 <= 2) {
                habilitarIndex = indexTab + 1;
                const bloquearIndex = IndexTabs.filter((i) => i != habilitarIndex);
                $("#tabs").tabs("option", "disabled", bloquearIndex);
                $("#tabs").tabs("option", "active", habilitarIndex);
                $("#btnSiguiente").prop("disabled", true);

                if (habilitarIndex === 1) {
                    $("#txtBuscarDoctor").val("");
                    $("#txtBuscarDoctor").trigger("focus");
                    ObtenerDoctores();
                } else if (habilitarIndex === 2) {
                    $("#txtFechaCita").val("");
                    ObtenerDoctoreHorarioDetalle();
                }
            }

            if (indexTab === 2) {
                $("#txtEspecialidad").val(EspecialidadSeleccionada);
                $("#txtDoctor").val(DoctorSeleccionado);
                $("#txtFechadeCita").val($("#txtFechaCita").val());
                $("#txtHoraCita").val(HoraSeleccionado);
                $("#mdData").modal("show");
            }
        });

        $("#btnRegresar").on("click", function () {
            const indexTab = $("#tabs").tabs("option", "active");
            let habilitarIndex = indexTab;
            if (indexTab - 1 >= 0) habilitarIndex = indexTab - 1;

            const bloquearIndex = IndexTabs.filter((i) => i != habilitarIndex);
            $("#tabs").tabs("option", "disabled", bloquearIndex);
            $("#tabs").tabs("option", "active", habilitarIndex);
            $("#btnSiguiente").prop("disabled", true);

            if (habilitarIndex === 0) {
                $("#txtBuscarEspecialidad").val("");
                $("#txtBuscarEspecialidad").trigger("focus");
                $(".card-especialidad").removeClass("text-white bg-primary");
                BuscarEspecialidad("");
            } else if (habilitarIndex === 1) {
                $("#txtBuscarDoctor").val("");
                $("#txtBuscarDoctor").trigger("focus");
                $(".card-doctor").removeClass("text-white bg-primary");
                BuscarDoctor("");
            }
        });

        function ObtenerDoctores() {
            $("#tab-doctor").LoadingOverlay("show");

            fetch(`/Doctor/Lista`, {
                method: "GET",
                headers: { 'Content-Type': 'application/json;charset=utf-8' }
            }).then(response => {
                return response.ok ? response.json() : Promise.reject(response);
            }).then(responseJson => {
                if (responseJson.data.length > 0) {
                    Doctores = responseJson.data.filter(
                        element => element.especialidad.idEspecialidad == IdEspecialidadSeleccionada
                    );
                    BuscarDoctor("");
                }
                $("#tab-doctor").LoadingOverlay("hide");
            }).catch((error) => {
                $("#tab-doctor").LoadingOverlay("hide");
                console.log(error);
                Swal.fire({
                    title: "Error!",
                    text: "No se encontraron coincidencias.",
                    icon: "warning"
                });
            });
        }

               function ObtenerDoctoreHorarioDetalle() {
            $("#txtFechaCita").datepicker("destroy");
            $("#tab-horario").LoadingOverlay("show");
            $("#contenedor-am").html("");
            $("#contenedor-pm").html("");

            fetch(`/Citas/ListaDoctorHorarioDetalle?Id=${IdDoctorSeleccionado}`, {
                method: "GET",
                headers: { 'Content-Type': 'application/json;charset=utf-8' }
            }).then(response => {
                return response.ok ? response.json() : Promise.reject(response);
            }).then(responseJson => {

                if (responseJson.data.length > 0) {
                    const arraySoloFechas = responseJson.data.map(item => item.fecha);
                    DoctorHorario = responseJson.data;

                    $("#txtFechaCita").datepicker({
                        /* comienzo cambio 9898 */
                        dateFormat: "dd/mm/yy", // Forzamos el formato aquí también
                        /* final cambio 9898 */
                        defaultDate: "",
                        minDate: 0,
                        beforeShowDay: function (date) {
                            var formattedDate = $.datepicker.formatDate("dd/mm/yy", date);
                            var esFechaPermitida = ($.inArray(formattedDate, arraySoloFechas) !== -1);
                            return [esFechaPermitida, ""];
                        },
                        onSelect: function () {
                            $("#btnSiguiente").prop("disabled", true);
                            $("#contenedor-am").html("");
                            $("#contenedor-pm").html("");

                            const selectedDate = $(this).val();

                            /* comienzo cambio 9898 */
                            // Buscamos la fecha tal cual la devuelve el datepicker configurado arriba
                            const Fecha = DoctorHorario.find(element => element.fecha.trim() == selectedDate.trim());

                            // Si por algún motivo de cultura de servidor 'Fecha' sigue siendo undefined,
                            // evitamos el crujido del programa con esta validación simple:
                            if (Fecha && Fecha.horarioDTO) {
                                const HorarioAM = Fecha.horarioDTO.filter(element => element.turno == "AM");
                                const HorarioPM = Fecha.horarioDTO.filter(element => element.turno == "PM");

                                HorarioAM.forEach(function (item) {
                                    $("#contenedor-am").append(
                                        `<div class="col mb-4">
                                            <div class="text-center card-hora"
                                                 style="cursor: pointer;border-radius: 0.375rem;border: 1px solid #ccc !important;"
                                                 data-id="${item.idDoctorHorarioDetalle}"
                                                 data-text="${item.turnoHora}">
                                                <h6 class="card-title mt-2">${item.turnoHora}</h6>
                                            </div>
                                         </div>`
                                    );
                                });

                                HorarioPM.forEach(function (item) {
                                    $("#contenedor-pm").append(
                                        `<div class="col mb-4">
                                            <div class="text-center card-hora"
                                                 style="cursor: pointer;border-radius: 0.375rem;border: 1px solid #ccc !important;"
                                                 data-id="${item.idDoctorHorarioDetalle}"
                                                 data-text="${item.turnoHora}">
                                                <h6 class="card-title mt-2">${item.turnoHora}</h6>
                                            </div>
                                         </div>`
                                    );
                                });
                            } else {
                                // Si no hay coincidencia, mostramos el aviso que ya conoces
                                Swal.fire({
                                    text: "No se encontró información detallada para la fecha seleccionada.",
                                    icon: "info"
                                });
                            }
                            /* final cambio 9898 */
                        }
                    });
                } else {
                    Swal.fire({
                        text: "No hay horarios disponibles.",
                        icon: "warning"
                    });
                }
                $("#tab-horario").LoadingOverlay("hide");
            }).catch((error) => {
                $("#tab-horario").LoadingOverlay("hide");
                Swal.fire({
                    title: "Error!",
                    text: "No se pudieron cargar los horarios.",
                    icon: "warning"
                });
            });
        }
        function enviarCita(objeto) {
            fetch(`/Citas/Guardar`, {
                method: "POST",
                headers: { 'Content-Type': 'application/json;charset=utf-8' },
                body: JSON.stringify(objeto)
            }).then(response => {
                return response.ok ? response.json() : Promise.reject(response);
            }).then(responseJson => {

                if (responseJson.data === "") {
                    Swal.fire({
                        title: "Felicidades!",
                        text: "Su cita fue registrada!",
                        icon: "success"
                    }).then(function () {
                    //    window.location.href = (ES_ADMIN ? '/Gestion/Index' : '/Citas/Index');
                                const urlInicio = document.getElementById('hdnUrlInicio').value;
        window.location.href = urlInicio;
                    });
                    $(`#${modal}`).modal('hide');
                } else {
                    Swal.fire({
                        title: "Error!",
                        text: responseJson.data,
                        icon: "warning"
                    });
                }
            }).catch((error) => {
                console.log(error);
                Swal.fire({
                    title: "Error!",
                    text: "No se pudo registrar.",
                    icon: "warning"
                });
            });
        }

        $("#btnAgendar").on("click", function () {

            if ($("#txtFechaCita").val() === "" || IdHoraSeleccionado === 0) {
                Swal.fire({
                    title: "Error!",
                    text: "Falta completar datos.",
                    icon: "warning"
                });
                return;
            }

            // Como admin: si no viene paciente, no llamamos al backend
            if (ES_ADMIN && (!ID_USUARIO_PACIENTE || ID_USUARIO_PACIENTE <= 0)) {
                Swal.fire({
                    title: "Atención",
                    text: "Como administrador debe abrir 'Nueva Cita' desde el botón 'Nueva cita' de un paciente (para que se pase su Id).",
                    icon: "info"
                });
                return;
            }

            const razon = $("#txtRazonCitaUsr").val() || "";
            const fileInput = $("#fileDocumentoCitaUsr")[0];

            const construirYEnviar = function (fileBase64, contentType) {

                let objeto = {
                    DoctorHorarioDetalle: {
                        IdDoctorHorarioDetalle: IdHoraSeleccionado
                    },
                    EstadoCita: {
                        IdEstadoCita: 1     // Pendiente
                    },
                    FechaCita: moment($("#txtFechaCita").val(), "DD/MM/YYYY").format('DD/MM/YYYY'),
                    OrigenCita: ES_ADMIN ? "ADMIN" : "WEB",
                    RazonCitaUsr: razon,
                    DocumentoCitaUsr: fileBase64,
                    ContentType: contentType
                };

                if (ES_ADMIN && ID_USUARIO_PACIENTE > 0) {
                    objeto.Usuario = {
                        IdUsuario: ID_USUARIO_PACIENTE
                    };
                }

                enviarCita(objeto);
            };

            if (fileInput && fileInput.files && fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();

                reader.onload = function (e) {
                    const result = e.target.result; // data:...;base64,XXXX
                    const base64Data = result.split(',')[1];
                    construirYEnviar(base64Data, file.type);
                };

                reader.onerror = function () {
                    Swal.fire({
                        title: "Error!",
                        text: "No se pudo leer el archivo adjunto.",
                        icon: "warning"
                    });
                };

                reader.readAsDataURL(file);
            } else {
                construirYEnviar(null, null);
            }
        });
    </script>
}
