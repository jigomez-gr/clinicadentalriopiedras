@{
    ViewData["Title"] = "Doctores";
}

@section Styles {
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    @* cambio datatable comzo *@
    @* Referencias necesarias para que la paginación y tablas recuperen el estilo Bootstrap *@
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />
    @* cambio datatable fin *@
    <style>

        .acciones-container {
            display: flex;
            gap: 4px;
        }

        .btn-circle {
            width: 32px;
            height: 32px;
            padding: 0;
            border-radius: 50%;
            text-align: center;
            font-size: 14px;
            line-height: 32px;
            display: inline-block;
            vertical-align: middle;
        }

        #tbData {
            border-collapse: collapse !important;
        }

        @@media (max-width: 768px) {
            #tbData thead th:first-child,
            #tbData tbody td:first-child {
                position: sticky;
                left: 0;
                background-color: #f8f9fa !important;
                z-index: 5;
                border-right: 2px solid #dee2e6;
            }
        }


        #ui-datepicker-div {
            z-index: 999999 !important;
        }

        .slot-btn-pac {
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 0.375rem;
            padding: 10px;
            text-align: center;
            background: #fff;
            min-width: 80px;
            font-weight: bold;
            display: inline-block;
        }

            .slot-btn-pac:hover {
                background: #f8f9fa;
                border-color: #198754;
            }

            .slot-btn-pac.active-slot {
                background-color: #198754 !important;
                color: #fff !important;
                border-color: #198754 !important;
            }

        .btn-repro-verde {
            color: #198754 !important;
            border: 1px solid #198754 !important;
            background-color: transparent !important;
        }

            .btn-repro-verde:hover {
                background-color: #198754 !important;
                color: white !important;
            }

        .tooltip-citas {
            --bs-tooltip-bg: #fff;
            --bs-tooltip-color: #000;
        }

        table.dataTable td, table.dataTable th {
            white-space: normal !important;
        }

        .dataTables_processing {
            background-color: #ffcccc !important;
            color: #d9534f !important;
            font-weight: bold !important;
            font-size: 1.2rem !important;
            border: 2px solid #d9534f !important;
            z-index: 9999 !important;
            top: 50% !important;
            height: auto !important;
            padding: 20px !important;
        }
    </style>
}

<div class="row">
    <div class="col-sm-12">
        <div class="card mb-4">
            <div class="card-header d-flex align-items-center">
                <i class="fa-solid fa-user-doctor me-2"></i>
                <span>Lista de Doctores</span>

                <button type="button"
                        class="btn btn-success btn-sm ms-auto"
                        onclick="openHelpVideo('Doctor_Horario.mp4')"
                        data-bs-toggle="tooltip" data-bs-placement="top" data-bs-custom-class="tooltip-citas"
                        title="Ayuda: abre el vídeo de explicación (wwwroot/helps/Doctor_Horario.mp4).">
                    <i class="fa fa-circle-question me-1"></i> Ayuda
                </button>
            </div>

            <div class="card-body">
                <div class="row">
                    <div class="col-sm-3">
                        <button class="btn btn-outline-success" id="btnNuevo">Nuevo Doctor</button>
                    </div>
                </div>
                <hr />

                <div class="row">
                    <div class="col-sm-12">
                        <div class="table-responsive">
                            <table class="display table table-striped table-bordered table-hover nowrap"
                                   id="tbData" style="width:100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>Acciones</th>
                                        <th>Nro Documento</th>
                                        <th>Nombres</th>
                                        <th>Apellidos</th>
                                        <th>Género</th>
                                        <th>Especialidad</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="mdData" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Doctor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body text-start">
                <div class="row g-2">
                    <div class="col-sm-6">
                        <label class="col-form-label">Nro Documento:</label>
                        <input type="text" class="form-control" id="txtNroDocumento" autocomplete="off">
                    </div>
                    <div class="col-sm-6">
                        <label class="col-form-label">Nombres:</label>
                        <input type="text" class="form-control" id="txtNombres" autocomplete="off">
                    </div>
                    <div class="col-sm-6">
                        <label class="col-form-label">Apellidos:</label>
                        <input type="text" class="form-control" id="txtApellidos" autocomplete="off">
                    </div>
                    <div class="col-sm-6">
                        <label class="col-form-label">Genero:</label>
                        <select id="cboGenero" class="form-control" data-width="100%"></select>
                    </div>
                    <div class="col-sm-12">
                        <label class="col-form-label">Especialidad:</label>
                        <select id="cboEspecialidad" class="form-control" data-width="100%"></select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-outline-success" id="btnCalcom" data-bs-toggle="tooltip" title="Configurar Cal.com">
                    <i class="fa-solid fa-link me-1"></i> Cal.com
                </button>
                <button type="button" class="btn btn-primary" id="btnGuardar">Guardar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="mdCalcom" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Config Cal.com (doctor)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body text-start">
                <div class="row g-2">
                    <div class="col-12 col-md-6">
                        <label class="form-label">API Key</label>
                        <input type="text" class="form-control" id="txtCalApiKey" autocomplete="off">
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Cal Username</label>
                        <input type="text" class="form-control" id="txtCalUsername" autocomplete="off">
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Event Type Id</label>
                        <input type="number" class="form-control" id="txtCalEventTypeId" autocomplete="off">
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Cal Public URL</label>
                        <input type="text" class="form-control" id="txtCalPublicUrl" autocomplete="off">
                    </div>
                    <div class="col-12 col-md-8">
                        <label class="form-label">Nombre del Evento (Cal)</label>
                        <input type="text" class="form-control" id="txtCalEventName" placeholder="Se cargará desde la API">
                    </div>
                    <div class="col-12 col-md-4">
                        <label class="form-label">Intervalo (min)</label>
                        <input type="number" class="form-control" id="txtCalSlotInterval" placeholder="30">
                    </div>
                    <div class="col-12 mt-2 d-none" id="divApiInfo">
                        <div class="alert alert-info py-2 mb-0">
                            <h6 class="alert-heading mb-1" style="font-size:0.9rem;"><i class="fa-solid fa-circle-info me-2"></i>Info detectada en API:</h6>
                            <div id="apiDetails" style="font-size: 0.8rem;"></div>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Email (Cal)</label>
                        <input type="text" class="form-control" id="txtCalEmail" autocomplete="off">
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Teléfono (Cal)</label>
                        <input type="text" class="form-control" id="txtCalTelefono" autocomplete="off">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Nombre y Apellido (Cal)</label>
                        <input type="text" class="form-control" id="txtCalNombreYApellido" autocomplete="off">
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Event Inbox</label>
                        <input type="text" class="form-control" id="txtCalEventInbox" autocomplete="off" placeholder="DEFAULT">
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Event Inbox URL</label>
                        <input type="text" class="form-control" id="txtCalEventInboxUrl" autocomplete="off">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="txtCalNotes" rows="2"></textarea>
                    </div>
                    <div class="col-12">
                        <div class="form-check mt-1">
                            <input class="form-check-input" type="checkbox" id="chkCalIsActive" checked>
                            <label class="form-check-label" for="chkCalIsActive">Activo</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-repro-verde" id="btnConsultarApi">
                    <i class="fa-solid fa-magnifying-glass me-1"></i> Consultar API
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarCalcom">Guardar Cal</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @* cambio datatable comzo *@
    @* Importante cargar el JS de integración con Bootstrap 5 *@
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    @* cambio datatable fin *@
    <script>
        (function () {
            "use strict";
            window.openHelpVideo = function (fileName) {
                const w = 900, h = 520;
                const left = Math.max(0, (screen.width - w) / 2);
                const top = Math.max(0, (screen.height - h) / 2);
                const url = "/helps/" + encodeURIComponent(fileName);
                window.open(url, "helpVideo", `width=${w},height=${h},left=${left},top=${top},resizable=yes,scrollbars=no,toolbar=no,menubar=no,location=no,status=no`);
            };

            function initTooltips(scope) {
                const root = scope || document;
                const triggers = root.querySelectorAll('[data-bs-toggle="tooltip"]');
                triggers.forEach(el => {
                    const inst = bootstrap.Tooltip.getInstance(el);
                    if (inst) return;
                    new bootstrap.Tooltip(el);
                });
            }

            let tablaData;
            let idEditar = 0;
            const controlador = "Doctor";
            const modal = "mdData";

            async function cargarGeneros() {
                const cbo = document.getElementById("cboGenero");
                if (!cbo) return;
                cbo.innerHTML = "";
                const o1 = document.createElement("option"); o1.value = "M"; o1.textContent = "M";
                const o2 = document.createElement("option"); o2.value = "F"; o2.textContent = "F";
                cbo.appendChild(o1); cbo.appendChild(o2);
            }

            async function cargarEspecialidades() {
                const r = await fetch("/Especialidad/Lista", { headers: { "Accept": "application/json" } });
                const j = await r.json().catch(() => null);
                const arr = (j && j.data) ? j.data : [];
                const cbo = document.getElementById("cboEspecialidad");
                cbo.innerHTML = "";
                for (const e of arr) {
                    const id = e.idEspecialidad ?? e.IdEspecialidad ?? 0;
                    const nom = e.nombre ?? e.Nombre ?? "";
                    const o = document.createElement("option");
                    o.value = id; o.textContent = nom;
                    cbo.appendChild(o);
                }
            }

            function limpiarModal() {
                idEditar = 0;
                $("#txtNroDocumento").val("");
                $("#txtNombres").val("");
                $("#txtApellidos").val("");
                $("#cboGenero").val("");
                $("#cboEspecialidad").val("");
            }

            function llenarModal(row) {
                limpiarModal();
                idEditar = row.idDoctor ?? row.IdDoctor ?? 0;
                $("#txtNroDocumento").val((row.numeroDocumentoIdentidad ?? row.NumeroDocumentoIdentidad ?? "").trim());
                $("#txtNombres").val((row.nombres ?? row.Nombres ?? "").trim());
                $("#txtApellidos").val((row.apellidos ?? row.Apellidos ?? "").trim());
                $("#cboGenero").val((row.genero ?? row.Genero ?? "").trim());
                const idEsp = row.especialidad?.idEspecialidad ?? row.Especialidad?.IdEspecialidad ?? 0;
                if (idEsp) $("#cboEspecialidad").val(idEsp);
            }

            async function guardarDoctor() {
                const nro = ($("#txtNroDocumento").val() || "").trim();
                const nom = ($("#txtNombres").val() || "").trim();
                const ape = ($("#txtApellidos").val() || "").trim();
                const gen = ($("#cboGenero").val() || "").trim();
                const idEsp = parseInt($("#cboEspecialidad").val() || "0", 10) || 0;

                if (!nro || !nom || !ape || !gen || !idEsp) {
                    Swal.fire("Aviso", "Completa documento, nombres, apellidos, género y especialidad.", "info");
                    return;
                }

                const payload = {
                    IdDoctor: idEditar,
                    NumeroDocumentoIdentidad: nro,
                    Nombres: nom,
                    Apellidos: ape,
                    Genero: gen,
                    Especialidad: { IdEspecialidad: idEsp }
                };

                const method = (idEditar && idEditar > 0) ? "PUT" : "POST";
                const url = "/" + controlador + ((method === "POST") ? "/Guardar" : "/Editar");
                const r = await fetch(url, {
                    method,
                    headers: { "Content-Type": "application/json;charset=utf-8" },
                    body: JSON.stringify(payload)
                });
                const j = await r.json().catch(() => null);
                const msg = j ? (j.data ?? j.msg ?? "") : "";
                if (!r.ok) { Swal.fire("Error", "HTTP " + r.status + " al guardar.", "error"); return; }
                if (msg && msg !== "") { Swal.fire("Aviso", msg, "warning"); return; }

                Swal.fire("OK", "Guardado.", "success");
                bootstrap.Modal.getOrCreateInstance(document.getElementById(modal)).hide();
                tablaData.ajax.reload(null, false);
            }

            function limpiarCalcomModal() {
                $("#txtCalApiKey").val("");
                $("#txtCalUsername").val("");
                $("#txtCalEventTypeId").val("");
                $("#txtCalPublicUrl").val("");
                $("#txtCalEmail").val("");
                $("#txtCalTelefono").val("");
                $("#txtCalNombreYApellido").val("");
                $("#txtCalEventInbox").val("DEFAULT");
                $("#txtCalEventInboxUrl").val("");
                $("#txtCalNotes").val("");
                $("#chkCalIsActive").prop("checked", true);
                $("#txtCalEventName").val("");
                $("#txtCalSlotInterval").val(30);
                $("#divApiInfo").addClass("d-none");
                $("#apiDetails").html("");
            }

            async function cargarCalcom(idDoctor) {
                limpiarCalcomModal();
                if (!idDoctor) return;
                const r = await fetch(`/Doctor/ObtenerCalcom?idDoctor=${encodeURIComponent(idDoctor)}`, { headers: { "Accept": "application/json" } });
                const j = await r.json().catch(() => null);
                if (!r.ok || !j) return;
                const d = j.data || {};
                $("#txtCalApiKey").val((d.apiKey || "").trim());
                $("#txtCalUsername").val((d.calUsername || "").trim());
                $("#txtCalEventTypeId").val(d.calEventTypeId ?? "");
                $("#txtCalPublicUrl").val((d.calPublicUrl || "").trim());
                $("#txtCalEmail").val((d.email || "").trim());
                $("#txtCalTelefono").val((d.telefono || "").trim());
                $("#txtCalNombreYApellido").val((d.nombreYApellido || "").trim());
                $("#txtCalEventInbox").val((d.eventInbox || "DEFAULT").trim());
                $("#txtCalEventInboxUrl").val((d.eventInboxUrl || "").trim());
                $("#txtCalNotes").val((d.notes || "").trim());
                $("#chkCalIsActive").prop("checked", (d.isActive !== false));
                $("#txtCalEventName").val((d.calEventName || "").trim());
                $("#txtCalSlotInterval").val(d.calSlotInterval ?? 30);
            }

            async function guardarCalcom(idDoctor) {
                if (!idDoctor) { Swal.fire("Error", "No hay idDoctor para guardar.", "error"); return; }
                const payload = {
                    idDoctor: idDoctor,
                    apiKey: ($("#txtCalApiKey").val() || "").trim(),
                    calUsername: ($("#txtCalUsername").val() || "").trim(),
                    calEventTypeId: parseInt($("#txtCalEventTypeId").val() || "0", 10) || null,
                    calPublicUrl: ($("#txtCalPublicUrl").val() || "").trim(),
                    email: ($("#txtCalEmail").val() || "").trim(),
                    telefono: ($("#txtCalTelefono").val() || "").trim(),
                    nombreYApellido: ($("#txtCalNombreYApellido").val() || "").trim(),
                    eventInbox: ($("#txtCalEventInbox").val() || "DEFAULT").trim(),
                    eventInboxUrl: ($("#txtCalEventInboxUrl").val() || "").trim(),
                    isActive: $("#chkCalIsActive").is(":checked"),
                    notes: ($("#txtCalNotes").val() || "").trim(),
                    calEventName: ($("#txtCalEventName").val() || "").trim(),
                    calSlotInterval: parseInt($("#txtCalSlotInterval").val() || "30", 10)
                };
                const r = await fetch("/Doctor/GuardarCalcom", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
                if (!r.ok) { Swal.fire("Error", "HTTP " + r.status, "error"); return; }
                Swal.fire("OK", "Configuración guardada.", "success");
                bootstrap.Modal.getInstance(document.getElementById("mdCalcom")).hide();
            }

            async function consultarInformacionApi() {
                const apiKey = ($("#txtCalApiKey").val() || "").trim();
                if (!apiKey) { Swal.fire("Aviso", "Se requiere la API Key.", "warning"); return; }
                $("#btnConsultarApi").prop("disabled", true).html('<i class="fa-solid fa-spinner fa-spin"></i> Consultando...');
                try {
                    const r = await fetch(`/Doctor/GetDetallesApiCal?apiKey=${encodeURIComponent(apiKey)}`);
                    const j = await r.json();
                    if (r.ok && j.data && Array.isArray(j.data)) {
                        const events = j.data;
                        $("#divApiInfo").removeClass("d-none");
                        let html = '<ul class="mb-0 list-unstyled">';
                        const currentId = parseInt($("#txtCalEventTypeId").val(), 10);
                        let encontrado = false;
                        events.forEach(e => {
                            const isSelected = (parseInt(e.id, 10) === currentId);
                            html += `<li class="mb-1 p-1 ${isSelected ? 'bg-light border-start border-success border-3' : ''}">
                                         ${isSelected ? '<strong>' : ''}ID: ${e.id} - ${e.title} (${e.length} min)${isSelected ? ' [ACTUAL]</strong>' : ''}
                                     </li>`;
                            if (isSelected) { encontrado = true; $("#txtCalEventName").val(e.title); $("#txtCalSlotInterval").val(e.length); }
                        });
                        html += '</ul>';
                        $("#apiDetails").html(html);
                        if (!encontrado && currentId) Swal.fire("Aviso", "ID " + currentId + " no existe en esta cuenta.", "info");
                    } else { Swal.fire("Error", j.msg || "Error API", "error"); }
                } catch (e) { Swal.fire("Error", "Fallo comunicación.", "error"); } finally {
                    $("#btnConsultarApi").prop("disabled", false).html('<i class="fa-solid fa-magnifying-glass me-1"></i> Consultar API');
                }
            }

            $(document).ready(async function () {
                initTooltips();
                await cargarGeneros();
                await cargarEspecialidades();

                /* cambio datatable comzo */
                tablaData = $("#tbData").DataTable({
                    processing: true,
                    responsive: false, // Usamos scrollX en lugar de responsive para control total móvil
                    scrollX: true,
                    ajax: {
                        url: "/" + controlador + "/Lista",
                        type: "GET",
                        dataType: "json",
                        dataSrc: function (json) { return (json && json.data) ? json.data : []; }
                    },
                    columns: [
                        {
                            data: null,
                            width: "100px",
                            orderable: false,
                            render: function (data, type, row) {
                                return `<div class="acciones-container">
                                            <button type="button" class="btn btn-primary btn-circle btn-editar" title="Editar"><i class="fas fa-edit"></i></button>
                                            <button type="button" class="btn btn-danger btn-circle btn-eliminar" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
                                        </div>`;
                            }
                        },
                        { data: "numeroDocumentoIdentidad" },
                        { data: "nombres" },
                        { data: "apellidos" },
                        { data: "genero" },
                        { data: "especialidad", render: (d) => d?.nombre || "" }
                    ],
                    language: {
                        url: "https://cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json"
                    }
                });
                /* cambio datatable fin */

                $("#btnNuevo").on("click", function() { limpiarModal(); bootstrap.Modal.getOrCreateInstance(document.getElementById(modal)).show(); });
                $("#btnConsultarApi").on("click", consultarInformacionApi);
                $("#tbData tbody").on("click", ".btn-editar", function () {
                    const row = tablaData.row($(this).closest("tr")).data();
                    llenarModal(row);
                    bootstrap.Modal.getOrCreateInstance(document.getElementById(modal)).show();
                });

                $("#tbData tbody").on("click", ".btn-eliminar", function () {
                    const row = tablaData.row($(this).closest("tr")).data();
                    const id = row.idDoctor ?? 0;
                    if (!id) return;
                    Swal.fire({ title: "¿Eliminar?", text: "Se eliminará el doctor.", icon: "warning", showCancelButton: true, confirmButtonText: "Sí", cancelButtonText: "No" })
                    .then(async (res) => {
                        if (!res.isConfirmed) return;
                        const r = await fetch("/" + controlador + "/Eliminar?idDoctor=" + encodeURIComponent(id), { method: "DELETE" });
                        if (r.ok) { Swal.fire("OK", "Eliminado.", "success"); tablaData.ajax.reload(null, false); }
                        else { Swal.fire("Error", "No se pudo eliminar.", "error"); }
                    });
                });

                $("#btnGuardar").on("click", guardarDoctor);
                $("#btnCalcom").on("click", async function () {
                    if (!idEditar) { Swal.fire("Aviso", "Primero pulsa Editar sobre un doctor.", "info"); return; }
                    bootstrap.Modal.getOrCreateInstance(document.getElementById("mdCalcom")).show();
                    await cargarCalcom(idEditar);
                });
                $("#btnGuardarCalcom").on("click", async function () { await guardarCalcom(idEditar); });
            });
        })();
    </script>
}